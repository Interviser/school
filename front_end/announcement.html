<!DOCTYPE html>
<html lang="en">
<head>
    <script>
         const verifyUser = async (e)=> {
            e.preventDefault()
           
            
            try { 
                const response = await fetch('api/auth/',{
                    method: 'GET',
                    credentials: 'include'
                })
                if(response.ok){
                     return
                }
                else {
                    window.location.href = 'login.html'
                    throw new Error('User not authenticated')}
                           
                }
             catch (err) {

                window.location.replace('login.html')
            }
        
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.css">
    <title>Announcement Page</title>
    <style>
        body{
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: white;
            max-width: 900px;
            margin-left: calc(calc(100% - 900px) / 2);
            margin-right: calc(calc(100% - 900px) / 2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;

        }
        h2{
            text-align: center;
            margin-bottom: 30px;
        }
        #announcement_list{
            max-width: 800px;
            margin: 0 auto;
        }
        .header_style{
            color: #d30fb6;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .message_style{
            color: #555;
            font-size: 18px;
            margin-bottom: 30px;
            white-space: inherit;
        }
        .edit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
    </style>    
</head>
<body>
    <h2>Announcements</h2>
    <div id="announcement_list">
        
    </div>
    
</body>
 <script src="../../node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
<script>
    const annouce = document.getElementById('announcement_list')
    const get_annouce = async (e)=> {
        const token = localStorage.getItem('token')

        try{
             const response = await fetch('api/announcements',{
                method: 'POST',
                     headers: {
                       'authorization': `Bearer ${token}`
                    }
        })
        if(response.ok){
            const data = await response.json()
            data.forEach(item => {
                const div = document.createElement('div')
                div.innerHTML = `<h4 class='header_style'>${item.header.toUpperCase()}</h4><p class="message_style">${item.message}</p><hr/> <button id="edit" class="edit-btn">Edit</button> <button id="delete" class="delete-btn">Delete</button>`
                const editAnnouncement = (_id) => {
                    const newHeader = prompt("Enter new header:", item.header);
                    const newMessage = prompt("Enter new message:", item.message);
                    if (newHeader && newMessage) {
                        fetch(`api/editMessage/${_id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ header: newHeader, message: newMessage })
                        })
                        .then(res => {
                            if (res.ok) {
                                alert("Announcement updated successfully!");
                                location.reload();
                            } else {
                                alert("Failed to update announcement.");
                            }
                        })
                        .catch(err => {
                            alert("Error");
                        });
                    }
                };
                const deleteAnnouncement = (_id) => {
                    if (confirm("Are you sure you want to delete this announcement?")) {
                        fetch(`api/deleteAnnouncement/${_id}`, {
                            method: 'DELETE',
                            headers: {
                                'authorization': `Bearer ${token}`
                            }
                        })
                        .then(res => {
                            if (res.ok) {
                                alert("Announcement deleted successfully!");
                                location.reload();
                            } else {
                                alert("Failed to delete announcement.");
                            }
                        })
                        .catch(err => {
                            alert("Error");
                        });
                    }
                };
                div.querySelector('#edit').addEventListener('click', () => editAnnouncement(item._id));
                div.querySelector('#delete').addEventListener('click', () => deleteAnnouncement(item._id));

                annouce.appendChild(div)
            });
        }
        else {
           alert("only admin can access this page")
        }   
    }
        catch(err){
            alert('Error fetching announcements: '+ err.message)
        }
    }

    document.addEventListener('DOMContentLoaded',get_annouce)
    

</script>
</html>